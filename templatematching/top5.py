from sentence_transformers import SentenceTransformer, util
import torch


# Corpus with example sentences
fact_templates = ['#的找矿标志是什么?',
               '#是否出露地层有$?',
               '#围岩蚀变有哪些?',
               '#主要围岩蚀变有哪些?',
               '#近矿围岩蚀变有哪些?',
               '#主要近矿围岩蚀变有哪些?',
               '#矿化蚀变类型有哪些?',
               '#主要矿化蚀变类型有哪些?',
               '#的主要导矿构造有哪些?',
               '#的主要容矿构造有哪些?',
               '#的断裂构造有哪些?',
               '#的控岩控矿构造有哪些?',
               '什么对#起控制作用?',
               '#所处的构造位置是哪里?',
               '#的区域构造位置是哪里?',
               '#主要产于哪些构造中?',
               '#位于哪里?',
               '#赋矿地层是哪个时代?',
               '#出露时代有哪些?',
               '#属于哪个构造带?',
               '#包含哪些地层?',
               '#有哪些矿物?',
               '#有哪些矿石?',
               '#有哪些共生矿物?',
               '#有哪些特征共生矿物?',
               '#有哪些脉体矿物?',
               '#有哪些基质?',
               '#有哪些有害伴生矿物?',
               '#有哪些伴生有益矿物组份?',
               '#有哪些次生氧化矿物?',
               '#有哪些副矿物?',
               '#包含哪些碱金属元素?',
               '#包含哪些金属元素?',
               '#包含哪些元素?',
               '#包含哪些有益元素?',
               '#包含哪些伴生有害元素?',
               '#赋存哪些地层?',
               '#出露地层有哪些?',
               '#赋矿层位有哪些?',
               '#有哪些地层呢?',
               '#含矿层位有哪些?',
               '#赋存于哪里?',
               '#主要容矿地层有哪些?',
               '#分布于哪里?',
               '#赋矿地层有哪些?',
               '#含有哪些岩石?',
               '#围岩有哪些?',
               '#含矿围岩有哪些?',
               '#东侧围岩有哪些?',
               '#西侧围岩有哪些?',
               '#南侧围岩有哪些?',
               '#北侧围岩有哪些?',
               '#含矿岩石有哪些?',
               '#岩性是哪些?',
               '#含有哪些岩浆岩?',
               '#含有哪些沉积岩?',
               '#含有哪些变质岩?',
               '#赋矿岩石有哪些?',
               '#上覆地层有哪些?',
               '#下部岩石有哪些?',
               '#有哪些岩体组成?',
               '#原岩有哪些?',
               '#组成部分有哪些？',
               '#岩石成份有哪些？',
               '#经历过哪些地质作用?',
               '#经历过哪些成矿作用?',
               '#是?时代?地层岩性有哪些?',
               '#成矿作用有哪些?',
               '#变质作用有哪些?',
               '#异常有哪些?',
               '#圈定异常有哪些?']
judgment_templates = ['$是#的找矿标志?',
                   '#的找矿标志包括$?',
                   '#的找矿标志有$?',
                   '$是不是#的找矿标志?',
                   '$是不是#的围岩蚀变?',
                   '$是#的围岩蚀变?',
                   '#的围岩蚀变包括$?',
                   '#的围岩蚀变有$?',
                   '$是不是#的主要围岩蚀变?',
                   '$是#的主要围岩蚀变?',
                   '#的主要围岩蚀变包括$?',
                   '#的主要围岩蚀变有$?',
                   '$是不是#的主要近矿围岩蚀变?',
                   '$是#的主要近矿围岩蚀变?',
                   '#的主要近矿围岩蚀变包括$?',
                   '#的主要近矿围岩蚀变有$?',
                   '$是不是#的矿化蚀变类型?',
                   '$是#的矿化蚀变类型?',
                   '#的矿化蚀变类型包括$?',
                   '#的矿化蚀变类型有$?',
                   '$是不是#的成矿蚀变?',
                   '$是#的成矿蚀变?',
                   '#的成矿蚀变包括$?',
                   '#的成矿蚀变有$?',
                   '$是不是#的主要矿化蚀变类型?',
                   '$是#的主要矿化蚀变类型?',
                   '#的主要矿化蚀变类型包括$?',
                   '#的主要矿化蚀变类型有$?',
                   '$是不是#的矿化类型?',
                   '$是#的矿化类型?',
                   '#的矿化类型包括$?',
                   '#的矿化类型有$?',
                   '$是不是#的与矿体关系密切的蚀变?',
                   '$是#的与矿体关系密切的蚀变?',
                   '#的与矿体关系密切的蚀变包括$?',
                   '#的与矿体关系密切的蚀变有$?',
                   '$是不是#的花岗岩体蚀变?',
                   '$是#的花岗岩体蚀变?',
                   '#的花岗岩体蚀变包括$?',
                   '#的花岗岩体蚀变有$?',
                   '$是不是#的控矿构造?',
                   '$是#的控矿构造?',
                   '#的控矿构造包括$?',
                   '#的控矿构造有$?',
                   '$是不是#的主要控矿构造?',
                   '$是#的主要控矿构造?',
                   '#的主要控矿构造包括$?',
                   '#的主要控矿构造有$?',
                   '$是不是#的导矿构造?',
                   '$是#的导矿构造?',
                   '#的导矿构造包括$?',
                   '#的导矿构造有$?',
                   '$是不是#的主要导矿构造?',
                   '$是#的主要导矿构造?',
                   '#的主要导矿构造包括$?',
                   '#的主要导矿构造有$?',
                   '$是不是#的容矿构造?',
                   '$是#的容矿构造?',
                   '#的容矿构造包括$?',
                   '#的容矿构造有$?',
                   '$是不是#的主要容矿构造?',
                   '$是#的主要容矿构造?',
                   '#的主要容矿构造包括$?',
                   '#的主要容矿构造有$?',
                   '$是不是#的断裂构造?',
                   '$是#的断裂构造?',
                   '#的断裂构造包括$?',
                   '#的断裂构造有$?',
                   '$是不是#的控岩控矿构造?',
                   '$是#的控岩控矿构造?'
                   '#的控岩控矿构造包括$?',
                   '#的控岩控矿构造有$?',
                   '$是不是控制#的构造?',
                   '$是控制#的构造?',
                   '$控制#的构造?',
                   '#位于$?',
                   '#是不是位于$?',
                   '#地处$?',
                   '#是不是地处$?',
                   '#分布于$?',
                   '#是不是分布于$?',
                   '#出露在$?',
                   '#是不是出露在$?',
                   '#所处的构造位置在$?',
                   '#所处的构造位置是不是在$?',
                   '#的区域构造位置在$?',
                   '#的区域构造位置是不是在$?',
                   '#主要产于哪些构造中?',
                   '#是不是主要产于哪些构造中?',
                   '#赋矿地层包含$时代?',
                   '#赋矿地层是不是包含$时代?',
                   '#出露时代包括$?',
                   '#出露时代是不是包括$?',
                   '#属于$构造带?',
                   '#是不是属于$构造带?',
                   '#包含$地层?',
                   '#是不是包含$地层?',
                   '#是不是有$矿物?',
                   '#有$矿物?',
                   '#是不是有$矿石?',
                   '#有$矿石?'
                   '#是不是有$共生矿物?',
                   '#有$共生矿物?',
                   '#是不是有$特征共生矿物?',
                   '#有$特征共生矿物?',
                   '#是不是有$脉体矿物?',
                   '#有$脉体矿物?',
                   '#是不是有$脉体矿物?',
                   '#有$脉体矿物?',
                   '#是不是有$基质?'
                   '#有$基质?',
                   '#是不是有$有害伴生矿物?',
                   '#有$有害伴生矿物?',
                   '#是不是有$伴生有益矿物组份?',
                   '#有$伴生有益矿物组份?',
                   '#是不是有$次生氧化矿物?',
                   '#有$次生氧化矿物?',
                   '#是不是有$副矿物?',
                   '#有$副矿物?',
                   '#是不是包含$碱金属元素?',
                   '#包含$碱金属元素?',
                   '#是不是包含$金属元素?',
                   '#包含$金属元素?',
                   '#是不是包含$元素?',
                   '#包含$元素?',
                   '#是不是包含$有益元素?',
                   '#包含$有益元素?',
                   '#是不是包含$伴生有害元素?',
                   '#包含$伴生有害元素?',
                   '#有$地层?',
                   '#赋存$地层?',
                   '#出露地层有$?',
                   '#赋矿层位有$?',
                   '#含矿层位有$?',
                   '#赋存于$?',
                   '#主要容矿地层有$?',
                   '#分布于$?',
                   '#赋矿地层有$?',
                   '#含有$岩石?',
                   '#围岩有$?',
                   '#含矿围岩有$?'
                   '#东侧围岩有$?',
                   '#西侧围岩有$?',
                   '#南侧围岩有$?',
                   '#北侧围岩有$?',
                   '#含矿岩石有$?',
                   '#岩性是$?',
                   '#含有$岩浆岩?',
                   '#含有$沉积岩?',
                   '#含有$变质岩?',
                   '#赋矿岩石有$?',
                   '#上覆地层有$?',
                   '#下部岩石有$?',
                   '#有$岩体组成?',
                   '#原岩有$？',
                   '#组成部分有$？',
                   '#岩石成份有$？',
                   '#经历过$地质作用?',
                   '#经历过$成矿作用?'
                   '#成矿作用有$?',
                   '#变质作用有$?',
                   '#是不是有$异常?',
                   '#异常有$?',
                   '#的圈定异常是不是有$?',
                   '#圈定异常包括$?',
                   '#圈定异常有$?']


embedder = SentenceTransformer('multi-qa-mpnet-base-dot-v1')
fact_embeddings = embedder.encode(fact_templates, convert_to_tensor=True)
judgment_embeddings = embedder.encode(judgment_templates, convert_to_tensor=True)


def template_match(question_type, user_query):
    """
        Perform semantic matching between user query and template corpus

        Args:
            question_type (bool): True for factual questions, False for judgmental questions
            user_query (str): Input question from user

        Returns:
            list: Top-k matching templates based on cosine similarity
        """
    # Encode user query into embedding
    query_embedding = embedder.encode([user_query], convert_to_tensor=True)

    # Select appropriate corpus and embeddings based on question type
    if question_type:
        corpus = fact_templates
        embeddings = fact_embeddings
    else:
        corpus = judgment_templates
        embeddings = judgment_embeddings

    # Calculate cosine similarity between query and corpus
    cosine_scores = util.cos_sim(query_embedding, embeddings)[0]

    # Get top-k most similar templates (limit to 5 or corpus size)
    top_k = min(5, len(corpus))
    top_indices = torch.topk(cosine_scores, k=top_k).indices.tolist()

    # Retrieve and return matching templates
    return [corpus[idx] for idx in top_indices]
